---
---
<div class="typeform-container">
  <div class="progress-bar">
    <div class="progress-fill" id="progress-fill"></div>
  </div>

  <form id="retro-typeform" action="#" method="POST" onsubmit="return false;">
    
    <!-- Step 1: Name -->
    <div class="step active" data-step="1">

    
      <div class="step-content">
        <label class="question-number">01</label>
        <h2 class="question-text">IDENTIFY YOURSELF.<br>WHAT IS YOUR CODENAME?</h2>
        <input type="text" id="name" name="name" placeholder="TYPE HERE..." autocomplete="off" />
        <button type="button" class="next-btn" onclick="nextStep(1)">CONFIRM >></button>
      </div>
    </div>

    <!-- Step 2: Phone -->
    <div class="step" data-step="2">
      <div class="step-content">
        <label class="question-number">02</label>
        <h2 class="question-text">SECURE LINE.<br>ENTER FREQUENCY (PHONE).</h2>
        <input type="tel" id="phone" name="phone" placeholder="000-000-0000" autocomplete="off" />
        <button type="button" class="next-btn" onclick="nextStep(2)">CONFIRM >></button>
        <button type="button" class="back-btn" onclick="prevStep(2)"><< BACK</button>
      </div>
    </div>

    <!-- Step 3: Team -->
    <div class="step" data-step="3">
      <div class="step-content">
        <label class="question-number">03</label>
        <h2 class="question-text">ALLEGIANCE.<br>WHICH SQUADRON?</h2>
        <input type="text" id="team" name="team" placeholder="TEAM NAME" autocomplete="off" />
        <button type="button" class="next-btn submit-btn" onclick="submitForm()">INITIALIZE UPLOAD</button>
        <button type="button" class="back-btn" onclick="prevStep(3)"><< BACK</button>
      </div>
    </div>

    <!-- Success Step -->
    <div class="step" data-step="4">
      <div class="step-content success-message">
        <h2 class="glitch-text">UPLOAD COMPLETE</h2>
        <p>WELCOME TO THE RESISTANCE.</p>
        <button type="button" class="next-btn" onclick="location.reload()">RESET SYSTEM</button>
      </div>
    </div>

  </form>
</div>

<script is:inline>
  let currentStep = 1;
  const totalSteps = 3;
  const SUPABASE_URL = "https://aihyunbaawpgfvpydkuz.supabase.co/functions/v1/smooth-processor";

  function updateProgress() {
    const progress = ((currentStep - 1) / totalSteps) * 100;
    const fill = document.getElementById('progress-fill');
    if (fill) fill.style.width = `${progress}%`;
  }

  function showStep(step) {
    document.querySelectorAll('.step').forEach(el => {
      el.classList.remove('active');
      el.classList.remove('exit-left');
    });
    
    const currentEl = document.querySelector(`.step[data-step="${step}"]`);
    if (currentEl) currentEl.classList.add('active');
    
    updateProgress();
    
    // Auto-focus input
    const input = currentEl.querySelector('input');
    if (input) setTimeout(() => input.focus(), 100);
  }

  window.nextStep = function(step) {
    const currentEl = document.querySelector(`.step[data-step="${step}"]`);
    const input = currentEl.querySelector('input');
    
    if (input && !input.value.trim()) {
      input.classList.add('shake');
      setTimeout(() => input.classList.remove('shake'), 500);
      return;
    }

    currentEl.classList.add('exit-left');
    currentStep++;
    setTimeout(() => showStep(currentStep), 300);
  }

  window.prevStep = function(step) {
    currentStep--;
    showStep(currentStep);
  }

  window.submitForm = async function() {
    const btn = document.querySelector('.submit-btn');
    const name = document.getElementById('name')?.value?.trim() || '';
    const phone = document.getElementById('phone')?.value?.trim() || '';
    const team = document.getElementById('team')?.value?.trim() || '';
    if (!name || !phone || !team) {
      const activeStep = document.querySelector('.step.active');
      const input = activeStep?.querySelector('input');
      if (input) {
        input.classList.add('shake');
        setTimeout(() => input.classList.remove('shake'), 500);
      }
      return;
    }
    btn.innerText = "PROCESSING...";
    btn.disabled = true;
    try {
      const response = await fetch(SUPABASE_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, phone, team })
      });
      const ct = response.headers.get('content-type') || '';
      const responseData = ct.includes('application/json') ? await response.json() : await response.text();
      if (!response.ok) {
        const errorMsg = responseData?.error || 'TRANSMISSION FAILED';
        throw new Error(errorMsg);
      }
      currentStep++;
      showStep(currentStep);
      const fill = document.getElementById('progress-fill');
      if (fill) fill.style.width = '100%';
    } catch (error) {
      btn.innerText = "RETRY";
    } finally {
      btn.disabled = false;
    }
  }

  // Enter key support
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const activeStep = document.querySelector('.step.active');
      if (activeStep) {
        const nextBtn = activeStep.querySelector('.next-btn');
        if (nextBtn) nextBtn.click();
      }
    }
  });

  updateProgress();
</script>

<style>
  .typeform-container {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
    padding: 0 1rem;
  }

  .progress-bar {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 8px;
    background: #333;
  }

  .progress-fill {
    height: 100%;
    background: #fff;
    width: 0%;
    transition: width 0.5s ease;
  }

  .step {
    position: absolute;
    width: 100%;
    max-width: 800px;
    padding: 2rem;
    opacity: 0;
    transform: translateY(50px);
    pointer-events: none;
    transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    left: 50%;
    transform: translateX(-50%) translateY(50px);
  }
  
  .step.active {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: all;
  }
  
  .step.exit-left {
    opacity: 0;
    transform: translateX(-50%) translateY(-50px);
  }

  .step-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    text-align: left;
  }

  .question-number {
    font-size: 1.2rem;
    color: #fff;
    border: 2px solid #fff;
    padding: 0.2rem 0.5rem;
    margin-bottom: 1rem;
    background: #000;
  }

  .question-text {
    font-size: 2.5rem;
    line-height: 1.2;
    margin-bottom: 2rem;
    text-transform: uppercase;
    font-weight: bold;
  }

  input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 4px solid #fff;
    color: #fff;
    font-size: 2rem;
    padding: 0.5rem 0;
    outline: none;
    margin-bottom: 2rem;
    border-radius: 0;
  }

  input::placeholder {
    color: #555;
  }

  input:focus {
    border-bottom-color: #fff;
    box-shadow: 0 10px 0 -5px #000;
  }

  .next-btn {
    font-size: 1.5rem;
    padding: 1rem 2rem;
    background: #fff;
    color: #000;
    border: 4px solid #fff;
    cursor: pointer;
    text-transform: uppercase;
    font-weight: bold;
    transition: all 0.2s;
    display: inline-block;
  }

  .next-btn:hover {
    background: #000;
    color: #fff;
    box-shadow: 6px 6px 0 #fff;
  }

  .back-btn {
    background: transparent;
    border: none;
    color: #777;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 1rem;
    text-transform: uppercase;
    text-decoration: underline;
  }

  .back-btn:hover {
    color: #fff;
  }

  .shake {
    animation: shake 0.5s;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
  }

  @media (max-width: 768px) {
    .typeform-container {
      padding: 0 0.5rem;
    }
    
    .step {
      padding: 1rem;
      max-width: 100%;
      left: 0;
      transform: translateX(0) translateY(50px);
    }
    
    .step.active {
      transform: translateX(0) translateY(0);
    }
    
    .step.exit-left {
      transform: translateX(0) translateY(-50px);
    }
    
    .step-content {
      width: 100%;
      padding: 0 1rem;
      max-width: 100%;
      align-items: flex-start;
    }
    
    .question-text {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      line-height: 1.3;
      text-align: left;
    }
    
    input {
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
      padding: 0.3rem 0;
      text-align: left;
    }
    
    .next-btn {
      font-size: 1.2rem;
      padding: 0.8rem 1.5rem;
    }
    
    .question-number {
      font-size: 1rem;
      padding: 0.15rem 0.4rem;
      margin-bottom: 0.8rem;
    }
    
    .back-btn {
      font-size: 0.9rem;
      margin-top: 0.8rem;
    }
  }
  
  @media (max-width: 480px) {
    .typeform-container {
      padding: 0 0.25rem;
    }
    
    .step {
      padding: 0.5rem;
      left: 0;
      transform: translateX(0) translateY(50px);
    }
    
    .step.active {
      transform: translateX(0) translateY(0);
    }
    
    .step.exit-left {
      transform: translateX(0) translateY(-50px);
    }
    
    .step-content {
      padding: 0 0.5rem;
      max-width: 100%;
      align-items: flex-start;
    }
    
    .question-text {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      text-align: left;
    }
    
    input {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      text-align: left;
    }
    
    .next-btn {
      font-size: 1.1rem;
      padding: 0.7rem 1.2rem;
      width: 100%;
      text-align: center;
    }
    
    .question-number {
      font-size: 0.9rem;
    }
    
    .back-btn {
      font-size: 0.8rem;
    }
  }
</style>
